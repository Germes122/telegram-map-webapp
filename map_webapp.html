<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Карта с Yandex Maps</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=43aa7db3-27ee-4ce1-927b-0cb976ded812&lang=ru_RU" type="text/javascript"></script>
    <style>
        html, body, #map {
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        #addressInputFrom, #addressInputTo {
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            box-sizing: border-box;
        }
        #sendButton {
            margin-top: 10px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #sendButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #sendButton img {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
<div id="controls">
    <input type="text" id="addressInputFrom" placeholder="Введите адрес погрузки и нажмите Enter">
    <input type="text" id="addressInputTo" placeholder="Введите адрес отгрузки и нажмите Enter">
    <button id="sendButton" disabled>
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Telegram_logo.svg/2048px-Telegram_logo.svg.png" alt="Отправить">
    </button>
</div>
<div id="map"></div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    ymaps.ready(init);

    function init() {
        const map = new ymaps.Map("map", {
            center: [55.76, 37.64], // Москва
            zoom: 10,
            controls: ['zoomControl']
        });

        const points = []; // Массив точек
        let route; // Ссылка на текущий маршрут

        // Обработка ввода адреса погрузки
        document.getElementById("addressInputFrom").addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                const query = e.target.value;
                ymaps.geocode(query).then(function (res) {
                    const firstGeoObject = res.geoObjects.get(0);
                    if (firstGeoObject) {
                        const coords = firstGeoObject.geometry.getCoordinates();
                        const placemark = new ymaps.Placemark(coords, {
                            balloonContent: `Погрузка: ${firstGeoObject.getAddressLine()}`
                        }, {
                            preset: 'islands#redIcon'
                        });

                        map.geoObjects.add(placemark);
                        points[0] = coords;

                        // Сохраняем точки в localStorage
                        localStorage.setItem('mapPoints', JSON.stringify(points));
                        checkRoute();
                    } else {
                        alert("Адрес погрузки не найден.");
                    }
                });
            }
        });

        // Обработка ввода адреса отгрузки
        document.getElementById("addressInputTo").addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                const query = e.target.value;
                ymaps.geocode(query).then(function (res) {
                    const firstGeoObject = res.geoObjects.get(0);
                    if (firstGeoObject) {
                        const coords = firstGeoObject.geometry.getCoordinates();
                        const placemark = new ymaps.Placemark(coords, {
                            balloonContent: `Отгрузка: ${firstGeoObject.getAddressLine()}`
                        }, {
                            preset: 'islands#blueIcon'
                        });

                        map.geoObjects.add(placemark);
                        points[1] = coords;

                        // Сохраняем точки в localStorage
                        localStorage.setItem('mapPoints', JSON.stringify(points));
                        checkRoute();
                    } else {
                        alert("Адрес отгрузки не найден.");
                    }
                });
            }
        });

        // Проверка и построение маршрута
        function checkRoute() {
            if (points.length === 2 && points[0] && points[1]) {
                if (route) {
                    map.geoObjects.remove(route);
                }
                ymaps.route(points, {
                    mapStateAutoApply: true
                }).then(function (r) {
                    route = r;
                    map.geoObjects.add(route);
                    document.getElementById("sendButton").disabled = false;
                }, function (error) {
                    alert("Ошибка построения маршрута: " + error.message);
                });
            }
        }

        // Отправка данных в Telegram бот
        document.getElementById("sendButton").addEventListener("click", function () {
            if (points.length === 2 && points[0] && points[1]) {
                const data = { from: points[0], to: points[1] };
                Telegram.WebApp.sendData(JSON.stringify(data));
            } else {
                alert("Добавьте оба адреса: погрузки и отгрузки.");
            }
        });

        // Восстановление точек из localStorage
        const savedPoints = JSON.parse(localStorage.getItem('mapPoints') || '[]');
        if (savedPoints.length === 2) {
            savedPoints.forEach((coords, index) => {
                const placemark = new ymaps.Placemark(coords, {
                    balloonContent: index === 0 ? "Погрузка" : "Отгрузка"
                }, {
                    preset: index === 0 ? 'islands#redIcon' : 'islands#blueIcon'
                });
                map.geoObjects.add(placemark);
                points[index] = coords;
            });
            checkRoute();
        }
    }
</script>
</body>
</html>
