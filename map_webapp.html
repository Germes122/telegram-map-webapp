<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Карта с Yandex Maps</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=43aa7db3-27ee-4ce1-927b-0cb976ded812&lang=ru_RU" type="text/javascript"></script>
    <style>
        html, body, #map {
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        #sendButton {
            margin-top: 10px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        #sendButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<div id="controls">
    <button id="sendButton" disabled>Отправить данные</button>
</div>
<div id="map"></div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    ymaps.ready(init);

    function init() {
        const map = new ymaps.Map("map", {
            center: [55.76, 37.64], // Москва
            zoom: 10,
            controls: ['zoomControl']
        });

        const points = []; // Массив точек
        let route; // Ссылка на текущий маршрут

        // Получаем текущую позицию пользователя
        ymaps.geolocation.get().then(function (res) {
            const userCoords = res.geoObjects.position;

            // Отображаем текущую позицию
            const userPlacemark = new ymaps.Placemark(userCoords, {
                balloonContent: 'Вы здесь'
            }, {
                preset: 'islands#blueDotIcon'
            });

            map.geoObjects.add(userPlacemark);
            map.setCenter(userCoords);

            // Обработка клика по карте — добавление точки
            map.events.add('click', function (e) {
                const coords = e.get('coords');
                const placemark = new ymaps.Placemark(coords, {
                    balloonContent: `Точка ${points.length + 1}`
                }, {
                    preset: 'islands#redIcon'
                });

                map.geoObjects.add(placemark);
                points.push(coords);

                // Сохраняем точки в localStorage
                localStorage.setItem('mapPoints', JSON.stringify(points));

                // Строим маршрут, если есть хотя бы 2 точки
                if (points.length > 1) {
                    if (route) {
                        map.geoObjects.remove(route);
                    }
                    ymaps.route(points, {
                        mapStateAutoApply: true
                    }).then(function (r) {
                        route = r;
                        map.geoObjects.add(route);
                        document.getElementById("sendButton").disabled = false;
                    }, function (error) {
                        alert("Ошибка построения маршрута: " + error.message);
                    });
                }
            });
        });

        // Отправка данных в Telegram бот
        document.getElementById("sendButton").addEventListener("click", function () {
            if (points.length > 1) {
                const data = { points };
                Telegram.WebApp.sendData(JSON.stringify(data));
            } else {
                alert("Добавьте хотя бы две точки.");
            }
        });

        // Восстановление точек из localStorage
        const savedPoints = JSON.parse(localStorage.getItem('mapPoints') || '[]');
        savedPoints.forEach(coords => {
            const placemark = new ymaps.Placemark(coords, {
                balloonContent: `Точка ${points.length + 1}`
            }, {
                preset: 'islands#redIcon'
            });
            map.geoObjects.add(placemark);
            points.push(coords);
        });

        // Если есть сохранённые точки, строим маршрут
        if (points.length > 1) {
            ymaps.route(points, {
                mapStateAutoApply: true
            }).then(function (r) {
                route = r;
                map.geoObjects.add(route);
                document.getElementById("sendButton").disabled = false;
            }, function (error) {
                alert("Ошибка построения маршрута: " + error.message);
            });
        }
    }
</script>
</body>
</html>
