<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Карта</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=43aa7db3-27ee-4ce1-927b-0cb976ded812&lang=ru_RU" type="text/javascript"></script>
    <style>
        html, body, #map {
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    ymaps.ready(init);

    function init() {
        const map = new ymaps.Map("map", {
            center: [55.76, 37.64], // Москва
            zoom: 10,
            controls: ['searchControl', 'zoomControl']
        });

        const searchControl = map.controls.get('searchControl');
        searchControl.options.set('size', 'large');

        let route; // Ссылка на текущий маршрут

        // Получаем текущую позицию пользователя
        ymaps.geolocation.get().then(function (res) {
            const userCoords = res.geoObjects.position;

            // Отображаем текущую позицию
            const userPlacemark = new ymaps.Placemark(userCoords, {
                balloonContent: 'Вы здесь'
            }, {
                preset: 'islands#blueDotIcon'
            });

            map.geoObjects.add(userPlacemark);
            map.setCenter(userCoords);

            // Обработка клика по карте — выбор точки и построение маршрута
            map.events.add('click', function (e) {
                const destCoords = e.get('coords');

                // Удаляем старый маршрут
                if (route) {
                    map.geoObjects.remove(route);
                }

                // Строим новый маршрут
                ymaps.route([userCoords, destCoords], {
                    mapStateAutoApply: true
                }).then(function (r) {
                    route = r;
                    map.geoObjects.add(route);
                }, function (error) {
                    alert("Ошибка построения маршрута: " + error.message);
                });
            });
        });
    }
</script>
</body>
</html>
